---
export const prerender = false;
import { actions } from "astro:actions";
import { AppBreadCrumb } from "@/components/admin/layouts/AppBreadcrumb";
import ProductLayout from "@/layouts/ProductLayout.astro";
import RelatedProduct from "@/components/user/products/RelatedProduct.astro";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { getProductImage } from "@/lib/utils";

const { slug } = Astro.params;

const { data: product } = await Astro.callAction(actions.getProductBySlug, {
  slug: slug ?? "",
});

if (!product) {
  return Astro.redirect("/not-found");
}

const thumbnailUrl = getProductImage(product?.imageUrl ?? "")[0] ?? "";
const productUrl = `/categories/${product?.categorySlug}`;
---

<ProductLayout
  title={product?.name}
  description={product?.description}
  image={thumbnailUrl}
  url={productUrl}
>
  <AppBreadCrumb
    items={[
      { id: 1, name: "Home", url: "/" },
      {
        id: 2,
        name: product?.categoryName,
        url: productUrl,
      },
      { id: 2, name: product?.name },
    ]}
  />
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
    <!-- Left: Product Image -->
    <div class="flex flex-col gap-4 items-center">
      <img
        src={thumbnailUrl}
        alt={product?.name}
        class="rounded-lg shadow max-w-full"
      />
      <!-- Optional gallery thumbs if imageUrl is array later -->
    </div>

    <!-- Right: Details -->
    <div class="space-y-4">
      <h1 class="text-3xl font-bold">{product?.name}</h1>
      <p class="text-xl font-semibold">
        ${product?.price}
      </p>

      <div class="mt-4">
        {
          product?.stock ? (
            <span class="text-green-500">In stock: {product?.stock}</span>
          ) : (
            <span class="text-red-500">Out of stock</span>
          )
        }
      </div>

      <Button variant="outline" size="lg">Add to cart</Button>
    </div>
  </div>

  <div class="py-6">
    <Label className="text-gray-900 text-md">Description</Label>
    <p class="text-gray-600 text-sm mt-2">{product?.description}</p>
  </div>

  <RelatedProduct server:defer categorySlug={product?.categorySlug} />
</ProductLayout>
